{% extends "base.html" %}
{% block title %}Poređenje ponuda{% endblock %}
{% block content %}
<div class="container" style="max-width: 1600px;">
    <h1>Alat za poređenje ponuda</h1>
    <p style="color: var(--text-muted); margin-bottom: 25px;">
        Poredite dva različita seta artikala ili popusta side-by-side.
        <strong style="color: var(--accent-warning);">Podaci se ne čuvaju u bazi podataka.</strong>
    </p>

    <!-- Comparison Summary Top Row -->
    <div class="grid-2-col-asymmetric" style="grid-template-columns: 1fr 1fr; margin-bottom: 30px; gap: 40px;">
        <!-- Summary Option A -->
        <div class="card" style="border-left: 5px solid var(--accent-primary);">
            <h3 style="margin-bottom: 15px;">OPCIJA A</h3>
            <div style="font-size: 0.95rem;">
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0;">
                    <span>SUMA:</span> <span id="total-net-a" style="font-weight: 600;">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; color: var(--accent-warning);">
                    <span>POPUST:</span> <span id="total-discount-a" style="font-weight: 600;">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; font-weight: 600;">
                    <span>UKUPNO:</span> <span id="total-after-disc-a">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0;">
                    <span>PDV:</span> <span id="total-vat-a">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.3rem; font-weight: 700; color: var(--accent-success);">
                    <span>UKUPNO ZA UPLATU:</span> <span id="total-gross-a">0,00</span>
                </div>
            </div>
        </div>

        <!-- Summary Option B -->
        <div class="card" style="border-left: 5px solid var(--accent-warning);">
            <h3 style="margin-bottom: 15px;">OPCIJA B</h3>
            <div style="font-size: 0.95rem;">
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0;">
                    <span>SUMA:</span> <span id="total-net-b" style="font-weight: 600;">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; color: var(--accent-warning);">
                    <span>POPUST:</span> <span id="total-discount-b" style="font-weight: 600;">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0; font-weight: 600;">
                    <span>UKUPNO:</span> <span id="total-after-disc-b">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; border-bottom: 1px solid var(--border-color); padding: 5px 0;">
                    <span>PDV:</span> <span id="total-vat-b">0,00</span>
                </div>
                <div
                    style="display: flex; justify-content: space-between; padding: 8px 0; font-size: 1.3rem; font-weight: 700; color: var(--accent-success);">
                    <span>UKUPNO ZA UPLATU:</span> <span id="total-gross-b">0,00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tables Row -->
    <div class="grid-2-col-asymmetric" style="grid-template-columns: 1fr 1fr; gap: 40px;">
        <!-- Side A -->
        <div class="card">
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Popust %:</label>
                        <input type="number" id="discount-a" value="0" step="any" oninput="sideChanged('a')"
                            style="margin-bottom: 0;">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">PDV %:</label>
                        <input type="number" id="vat-a" value="20" step="any" oninput="sideChanged('a')"
                            style="margin-bottom: 0;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Filter Brend:</label>
                        <select id="filter-brand-a" onchange="applyFilters('a')"
                            style="margin-bottom: 0; font-size: 0.85rem; padding: 6px;">
                            <option value="">-- Svi brendovi --</option>
                            {% for b in brand_options %}
                            <option value="{{ b }}">{{ b }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Filter Kategorija:</label>
                        <select id="filter-category-a" onchange="applyFilters('a')"
                            style="margin-bottom: 0; font-size: 0.85rem; padding: 6px;">
                            <option value="">-- Sve kategorije --</option>
                            {% for c in category_options %}
                            <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <table class="preset-table" style="font-size: 0.75rem;">
                <thead>
                    <tr>
                        <th style="width: 30px;">br.</th>
                        <th style="width: 40%;">Proizvod</th>
                        <th style="width: 60px;">Kom</th>
                        <th>Cena kom</th>
                        <th>Red zbir</th>
                        <th>Sa pop.</th>
                        <th style="width: 30px;"></th>
                    </tr>
                </thead>
                <tbody id="body-a"></tbody>
            </table>
            <button class="btn btn-sm btn-primary" onclick="addRow('a')" style="width: 100%; margin-top: 10px;">+ Dodaj
                red</button>
        </div>

        <!-- Side B -->
        <div class="card">
            <div style="background: rgba(255,255,255,0.03); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Popust %:</label>
                        <input type="number" id="discount-b" value="0" step="any" oninput="sideChanged('b')"
                            style="margin-bottom: 0;">
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">PDV %:</label>
                        <input type="number" id="vat-b" value="20" step="any" oninput="sideChanged('b')"
                            style="margin-bottom: 0;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Filter Brend:</label>
                        <select id="filter-brand-b" onchange="applyFilters('b')"
                            style="margin-bottom: 0; font-size: 0.85rem; padding: 6px;">
                            <option value="">-- Svi brendovi --</option>
                            {% for b in brand_options %}
                            <option value="{{ b }}">{{ b }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: var(--text-muted);">Filter Kategorija:</label>
                        <select id="filter-category-b" onchange="applyFilters('b')"
                            style="margin-bottom: 0; font-size: 0.85rem; padding: 6px;">
                            <option value="">-- Sve kategorije --</option>
                            {% for c in category_options %}
                            <option value="{{ c }}">{{ c }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <table class="preset-table" style="font-size: 0.75rem;">
                <thead>
                    <tr>
                        <th style="width: 30px;">br.</th>
                        <th style="width: 40%;">Proizvod</th>
                        <th style="width: 60px;">Kom</th>
                        <th>Cena kom</th>
                        <th>Red zbir</th>
                        <th>Sa pop.</th>
                        <th style="width: 30px;"></th>
                    </tr>
                </thead>
                <tbody id="body-b"></tbody>
            </table>
            <button class="btn btn-sm btn-primary" onclick="addRow('b')" style="width: 100%; margin-top: 10px;">+ Dodaj
                red</button>
        </div>
    </div>
</div>

<!-- Product Data for JS -->
<script id="product-data" type="application/json">
    [
        {% for p in products %}
        {
            "id": {{ p.id }},
            "name": "{{ p.name | replace('"', '\\"') }}",
            "brand": "{{ p.brand or '' }}",
            "category": "{{ p.category or '' }}",
            "price": {{ p.latest_price if p.latest_price is not none else 0 }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ]
</script>

<script>
    const allProducts = JSON.parse(document.getElementById('product-data').textContent);

    function formatAmount(v) {
        return v.toLocaleString('sr-RS', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function addRow(side) {
        const tbody = document.getElementById('body-' + side);
        const tr = document.createElement('tr');

        tr.innerHTML = `
            <td class="row-num" style="text-align: center; color: var(--text-muted);"></td>
            <td>
                <select class="product-sel" onchange="productChanged(this, '${side}')" style="margin-bottom: 0; padding: 2px; font-size: 0.75rem;">
                    <!-- options filled by applyFilters -->
                </select>
                <input type="text" class="item-name" placeholder="Slobodan unos..." style="margin-top: 5px; margin-bottom: 0; padding: 2px; font-size: 0.75rem;">
            </td>
            <td><input type="number" class="qty" value="1" step="any" oninput="calcSide('${side}')" style="margin-bottom: 0; padding: 2px; font-size: 0.75rem;"></td>
            <td><input type="number" class="price" value="0" step="any" oninput="calcSide('${side}')" style="margin-bottom: 0; padding: 2px; font-size: 0.75rem;"></td>
            <td style="text-align: right; font-weight: 500;" class="line-sum">0,00</td>
            <td style="text-align: right; font-weight: 600; color: var(--accent-success);" class="line-sum-after">0,00</td>
            <td style="text-align: right;"><button class="btn btn-sm btn-danger" onclick="this.closest('tr').remove(); updateRowNumbers('${side}'); calcSide('${side}')" style="padding: 0px 5px; font-size: 0.7rem;">×</button></td>
        `;
        tbody.appendChild(tr);

        applyFiltersToRow(tr, side);
        updateRowNumbers(side);
        calcSide(side);
    }

    function updateRowNumbers(side) {
        const tbody = document.getElementById('body-' + side);
        tbody.querySelectorAll('tr').forEach((tr, idx) => {
            tr.querySelector('.row-num').innerText = idx + 1;
        });
    }

    function productChanged(sel, side) {
        const tr = sel.closest('tr');
        const opt = sel.options[sel.selectedIndex];
        const nameInput = tr.querySelector('.item-name');
        const priceInput = tr.querySelector('.price');

        if (sel.value) {
            nameInput.value = opt.text;
            priceInput.value = opt.dataset.price;
            nameInput.style.display = 'none';
        } else {
            nameInput.style.display = 'block';
            nameInput.value = '';
            priceInput.value = '0';
        }
        calcSide(side);
    }

    function applyFilters(side) {
        const tbody = document.getElementById('body-' + side);
        const rows = tbody.querySelectorAll('tr');
        rows.forEach(tr => {
            applyFiltersToRow(tr, side);
        });
    }

    function applyFiltersToRow(tr, side) {
        const sel = tr.querySelector('.product-sel');
        const brand = document.getElementById('filter-brand-' + side).value;
        const cat = document.getElementById('filter-category-' + side).value;
        const currentVal = sel.value;

        let html = '<option value="">-- slobodan unos --</option>';
        allProducts.forEach(p => {
            if ((!brand || p.brand === brand) && (!cat || p.category === cat)) {
                html += `<option value="${p.id}" data-price="${p.price}" ${currentVal == p.id ? 'selected' : ''}>${p.name}</option>`;
            }
        });
        sel.innerHTML = html;
    }

    function sideChanged(side) {
        calcSide(side);
    }

    function calcSide(side) {
        let totalNet = 0;
        const tbody = document.getElementById('body-' + side);
        const rows = tbody.querySelectorAll('tr');
        const discPercent = parseFloat(document.getElementById('discount-' + side).value) || 0;
        const vatPercent = parseFloat(document.getElementById('vat-' + side).value) || 0;
        const multiplier = (1 - discPercent / 100);

        rows.forEach(tr => {
            const qty = parseFloat(tr.querySelector('.qty').value) || 0;
            const price = parseFloat(tr.querySelector('.price').value) || 0;
            const lineSum = qty * price;
            const lineSumAfter = lineSum * multiplier;

            tr.querySelector('.line-sum').innerText = formatAmount(lineSum);
            tr.querySelector('.line-sum-after').innerText = formatAmount(lineSumAfter);
            totalNet += lineSum;
        });

        const totalDisc = totalNet * (discPercent / 100);
        const netAfterDisc = totalNet - totalDisc;
        const totalVat = netAfterDisc * (vatPercent / 100);
        const totalGross = netAfterDisc + totalVat;

        document.getElementById('total-net-' + side).innerText = formatAmount(totalNet);
        document.getElementById('total-discount-' + side).innerText = formatAmount(totalDisc);
        document.getElementById('total-after-disc-' + side).innerText = formatAmount(netAfterDisc);
        document.getElementById('total-vat-' + side).innerText = formatAmount(totalVat);
        document.getElementById('total-gross-' + side).innerText = formatAmount(totalGross);
    }

    document.addEventListener('DOMContentLoaded', () => {
        addRow('a');
        addRow('b');
    });
</script>

<style>
    .grid-2-col-asymmetric {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 40px;
    }

    input[type="number"],
    select {
        width: 100%;
        background-color: var(--bg-input);
        color: var(--text-main);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 5px;
    }

    .preset-table th {
        background: var(--table-header-bg);
        padding: 8px;
        text-align: center;
    }

    .preset-table td {
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
    }

    .card h3 {
        color: var(--text-muted);
        font-size: 1rem;
        letter-spacing: 1px;
    }
</style>
{% endblock %}