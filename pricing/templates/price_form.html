{% extends "base.html" %}
{% block title %}
{% if price %}Edit Price - {{ product.name }}{% else %}New Price - {{ product.name }}{% endif %}
{% endblock %}

{% block content %}
<h1>
    {% if price %}Edit price – {{ product.name }}{% else %}New price – {{ product.name }}{% endif %}
</h1>

<style>
    .forms-row {
        display: flex;
        gap: 2rem;
        /* space between the two columns */
        align-items: flex-start;
    }

    .forms-row .form-column {
        flex: 1;
        /* make both columns share the space */
    }
</style>

<div class="card">
    <form method="post" id="price-form">
        <p>
            <label>Datum:<br>
                <input type="date" name="date" style="width: 100%;"
                    value="{% if price %}{{ price.date }}{% else %}{{ today }}{% endif %}">
            </label>
        </p>

        <div class="forms-row">
            <!-- LEFT COLUMN: Troskovi -->
            <div class="form-column">

                <div class="card" style="border-left: 5px solid #e74c3c;">
                    <h2 style="color: #e74c3c;">Troskovi</h2>

                    <!-- Collapsible Currency Converter -->
                    <details
                        style="margin-bottom: 20px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; background: rgba(255,255,255,0.03);">
                        <summary style="cursor: pointer; font-weight: bold; color: var(--text-muted); font-size: 14px;">
                            Cena RSD/USD (Konvertor u EUR)
                        </summary>
                        <div style="margin-top: 15px;">
                            <p>
                                <label>Valuta:<br>
                                    <select id="conv_currency" onchange="updateConversion()">
                                        <option value="RSD">RSD</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </label>
                            </p>
                            <p>
                                <label>Iznos:<br>
                                    <input type="number" step="any" id="conv_amount" oninput="updateConversion()"
                                        placeholder="npr. 120000">
                                </label>
                            </p>
                            <div id="rsd_rate_box">
                                <p>
                                    <label>Kurs (EUR/RSD):<br>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" step="any" id="conv_rate_eur"
                                                oninput="updateConversion()" placeholder="117.3..."
                                                style="margin-bottom: 0;">
                                            <button type="button" class="btn btn-sm btn-primary"
                                                onclick="fetchRate('eur', 'conv_rate_eur')">Preuzmi kurs</button>
                                        </div>
                                    </label>
                                </p>
                            </div>
                            <div id="usd_rate_box" style="display: none;">
                                <p>
                                    <label>Kurs (EUR/USD):<br>
                                        <div style="display: flex; gap: 8px; align-items: center;">
                                            <input type="number" step="any" id="conv_rate_usd_eur"
                                                oninput="updateConversion()" placeholder="1.08..."
                                                style="margin-bottom: 0;">
                                            <button type="button" class="btn btn-sm btn-primary"
                                                onclick="fetchUsdEurRate()">Preuzmi kurs</button>
                                        </div>
                                    </label>
                                </p>
                            </div>
                            <!-- Status Notification -->
                            <p style="margin-top: -10px; margin-bottom: 10px;">
                                <small id="rate_status" style="color: var(--text-muted); font-style: italic;"></small>
                            </p>
                            <p style="font-size: 11px; margin-top: -5px;">
                                <a href="https://www.nbs.rs/sr_RS/finansijsko-trziste/devizno-trziste/kursna-lista/za-donosioca/index.html"
                                    target="_blank" style="color: var(--text-muted); text-decoration: none;">Izvor:
                                    NBS</a>
                            </p>
                            <p
                                style="background: rgba(46, 204, 113, 0.1); padding: 10px; border-radius: 4px; margin-top: 10px;">
                                <strong>Rezultat u EUR: </strong>
                                <span id="conv_result_display" style="color: #2ecc71; font-weight: bold;">0.00</span>
                                <button type="button" class="btn btn-sm btn-success" style="margin-left: 10px;"
                                    onclick="applyConversion()">Primeni</button>
                            </p>
                        </div>
                    </details>

                    <p>
                        <label>Nabavna cena:<br>
                            <input type="number" step="any" name="base_price" id="base_price" required
                                oninput="calculatePrice(this);" value="{% if price %}{{ price.base_price }}{% endif %}">
                        </label>
                    </p>

                    <p>
                        <label>Dodatni troskovi:<br>
                            <input type="number" step="any" name="extras" id="extras" oninput="calculatePrice(this)"
                                value="{% if price %}{{ price.extras }}{% else %}{{ defaults.extras }}{% endif %}">
                        </label>
                    </p>

                    <p>
                        <label>Uvoz %:<br>
                            <input type="number" step="any" name="import_percent" id="import_percent"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ ((price.import_percent or 0) * 100) | round(2) }}{% else %}{{ defaults.import_percent | round(2) }}{% endif %}">
                        </label>
                    </p>

                    <p>
                        <label>Domaci transport:<br>
                            <input type="number" step="any" name="domestic_transport" id="domestic_transport"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ price.domestic_transport }}{% else %}{{ defaults.domestic_transport }}{% endif %}">
                        </label>
                    </p>

                    <p>
                        <label>Garancija %:<br>
                            <input type="number" step="any" name="warranty_percent" id="warranty_percent"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ ((price.warranty_percent or 0) * 100) | round(2) }}{% else %}{{ defaults.warranty_percent | round(2) }}{% endif %}">
                        </label>
                    </p>
                    <p>
                        <label>Servis %:<br>
                            <input type="number" step="any" name="service_percent" id="service_percent"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ ((price.service_percent or 0) * 100) | round(2) }}{% else %}{{ defaults.service_percent | round(2) }}{% endif %}">
                        </label>
                    </p>
                    <p>
                        <label>Instalacija:<br>
                            <input type="number" step="any" name="instalation" id="instalation"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ price.instalation }}{% else %}{{ defaults.instalation }}{% endif %}">
                        </label>
                    </p>
                    <p>
                        <label>Obuka:<br>
                            <input type="number" step="any" name="traning" id="traning" oninput="calculatePrice(this)"
                                value="{% if price %}{{ price.traning }}{% else %}{{ defaults.traning }}{% endif %}">
                        </label>
                    </p>
                    <p>
                        <label>Ostalo:<br>
                            <input type="number" step="any" name="other" id="other" oninput="calculatePrice(this)"
                                value="{% if price %}{{ price.other }}{% else %}{{ defaults.other }}{% endif %}">
                        </label>
                    </p>

                    <div
                        style="margin-top: 15px; padding: 10px; background: rgba(231, 76, 60, 0.1); border-radius: 6px;">
                        <span
                            style="color: var(--text-muted); text-transform: uppercase; font-size: 11px; font-weight: bold;">Ukupno
                            kostanje</span><br>
                        <span id="cost_total_display"
                            style="font-size: 22px; font-weight: bold; color: #e74c3c;">–</span>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="form-column">
                <!-- Card: Final Price -->
                <div class="card" style="border-left: 5px solid #2ecc71;">
                    <h2 style="color: #2ecc71;">Konačna cena i zarada</h2>
                    <p>
                        <label>Zarada %:<br>
                            <input type="number" step="any" name="margin_percent" id="margin_percent"
                                oninput="calculatePrice(this)"
                                value="{% if price %}{{ ((price.margin_percent or 0) * 100) | round(2) }}{% else %}{{ defaults.margin_percent | round(2) }}{% endif %}">
                        </label>
                    </p>

                    <p>
                        <strong>Izracunata cena:</strong>
                        <span id="calculated_price_display">–</span><br>
                    </p>

                    <p>
                        <label>Konacna cena (lepa okrugla):<br>
                            <input type="number" step="any" name="final_price" id="final_price"
                                oninput="calculatePrice(this)" value="{% if price %}{{ price.final_price }}{% endif %}">
                            <small>optional, ako se ostavi prazno koristi Izracunatu cenu</small>
                        </label>
                    </p>

                    <div
                        style="margin-top: 15px; padding: 10px; background: rgba(46, 204, 113, 0.1); border-radius: 6px;">
                        <span
                            style="color: var(--text-muted); text-transform: uppercase; font-size: 11px; font-weight: bold;">Profit
                            (Konačna cena)</span><br>
                        <span id="profit_final_display"
                            style="font-size: 22px; font-weight: bold; color: #2ecc71;">–</span>
                    </div>
                </div>

                <!-- Card: Popust -->
                <div class="card" style="margin-top: 2rem; border-left: 5px solid #3498db;">
                    <h2 style="color: #3498db;">Popust</h2>
                    <p>
                        <label>Popust % (optional):<br>
                            <input type="number" step="any" name="discount_percent" id="discount_percent"
                                oninput="calculatePrice(this)"
                                value="{% if price and price.discount_percent is not none %}{{ (price.discount_percent * 100) | round(2) }}{% endif %}">
                            <small>e.g. 10 for 10% off final price</small>
                        </label>
                    </p>

                    <p>
                        <strong>Izračunata cena sa popustom:</strong>
                        <span id="calculated_discount_display">–</span><br>
                    </p>

                    <p>
                        <label>Cena sa popustom (lepa okrugla, optional):<br>
                            <input type="number" step="any" name="discount_price" id="discount_price"
                                oninput="calculatePrice(this)"
                                value="{% if price and price.discount_price is not none %}{{ price.discount_price }}{% endif %}">
                            <small>optional, ako se ostavi prazno koristi Izracunatu cenu</small>
                        </label>
                    </p>

                    <div
                        style="margin-top: 15px; padding: 10px; background: rgba(52, 152, 219, 0.1); border-radius: 6px;">
                        <span
                            style="color: var(--text-muted); text-transform: uppercase; font-size: 11px; font-weight: bold;">Profit
                            (Cena sa popustom)</span><br>
                        <span id="profit_discount_display"
                            style="font-size: 22px; font-weight: bold; color: #3498db;">–</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SUMMARY FOOTER -->
        <div class="card"
            style="margin-top: 2rem; border-top: 5px solid #2ecc71; display: flex; justify-content: space-between; align-items: center; padding: 20px 30px; background: var(--bg-card);">
            <div style="display: flex; gap: 40px;">
                <div>
                    <label
                        style="margin-bottom: 4px; color: var(--text-muted); text-transform: uppercase; font-size: 11px; letter-spacing: 1px; font-weight: bold;">Konačna
                        cena</label>
                    <div id="summary_final_price" style="font-size: 28px; font-weight: bold; color: #2ecc71;">–
                    </div>
                </div>
                <div>
                    <label
                        style="margin-bottom: 4px; color: var(--text-muted); text-transform: uppercase; font-size: 11px; letter-spacing: 1px; font-weight: bold;">Cena
                        sa popustom</label>
                    <div id="summary_discount_price" style="font-size: 28px; font-weight: bold; color: #3498db;">–</div>
                </div>
            </div>
            <button type="submit" class="btn btn-success"
                style="padding: 16px 50px; font-size: 18px; font-weight: bold; border-radius: 12px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.3);">Sacuvaj
                cenu</button>
        </div>
    </form>
</div>

<script type="application/json" id="rounding-rules-data">
    {{ rounding_rules | tojson | safe }}
</script>

<script>
    function parseNumber(value) {
        if (typeof value === "string") {
            value = value.replace(",", ".");
        }
        var num = parseFloat(value);
        return isNaN(num) ? 0 : num;
    }

    const rrData = document.getElementById('rounding-rules-data').textContent;
    const roundingRules = rrData ? JSON.parse(rrData) : {};

    function applyRounding(val, target = 'price') {
        if (val <= 0) return 0;

        const rules = roundingRules[target] || [];
        // Find the rule: smallest limit >= val
        let rule = rules.find(r => r.limit >= val);

        // If no rule found, use the last one (largest limit)
        if (!rule && rules.length > 0) {
            rule = rules[rules.length - 1];
        }

        if (!rule) return val;

        const step = rule.step;
        const method = rule.method || 'UP';

        if (method === 'UP') {
            return Math.ceil(val / step) * step;
        } else if (method === 'DOWN') {
            return Math.floor(val / step) * step;
        } else if (method === 'NEAREST') {
            return Math.round(val / step) * step;
        }
        return Math.ceil(val / step) * step;
    }

    function calculatePrice(source) {
        const basePrice = parseNumber(document.getElementById("base_price").value);
        const extras = parseNumber(document.getElementById("extras").value);
        const importPercentVal = parseNumber(document.getElementById("import_percent").value);
        const marginPercentVal = parseNumber(document.getElementById("margin_percent").value);

        // New fields
        const warrantyPercentVal = parseNumber(document.getElementById("warranty_percent").value);
        const servicePercentVal = parseNumber(document.getElementById("service_percent").value);
        const instalation = parseNumber(document.getElementById("instalation").value);
        const traning = parseNumber(document.getElementById("traning").value);
        const other = parseNumber(document.getElementById("other").value);

        const domTransport = parseNumber(document.getElementById("domestic_transport").value);

        const discountPercentInput = document.getElementById("discount_percent");
        const discountPriceInput = document.getElementById("discount_price");

        let discountPercentVal = parseNumber(discountPercentInput.value);
        let discountPriceVal = parseNumber(discountPriceInput.value);

        // Convert percents like 7, 40, 10 into 0.07, 0.40, 0.10
        const importPercent = importPercentVal / 100.0;
        const marginPercent = marginPercentVal / 100.0;
        const warrantyPercent = warrantyPercentVal / 100.0;
        const servicePercent = servicePercentVal / 100.0;
        const discountPercent = discountPercentVal / 100.0;

        const baseTotal = basePrice + extras;

        const costTotal = baseTotal * (1 + importPercent + warrantyPercent + servicePercent) + domTransport + instalation + traning + other;
        const calculatedPrice = costTotal * (1 + marginPercent);

        const finalPriceField = document.getElementById("final_price");
        let finalPrice = parseNumber(finalPriceField.value);

        const costFields = ["base_price", "extras", "import_percent", "margin_percent", "warranty_percent", "service_percent", "instalation", "traning", "other", "domestic_transport"];

        if (source && (costFields.includes(source.id) || source.id === "price-form")) {
            finalPrice = applyRounding(calculatedPrice, 'price');
            finalPriceField.value = finalPrice.toFixed(2);
        } else if (!finalPrice && calculatedPrice > 0) {
            finalPrice = applyRounding(calculatedPrice, 'price');
            finalPriceField.value = finalPrice.toFixed(2);
        }

        const profitFinal = finalPrice - costTotal;

        const rawDiscountPrice = finalPrice * (1 - discountPercent);
        document.getElementById("calculated_discount_display").textContent = rawDiscountPrice.toFixed(2);

        let finalDiscountPrice = 0;
        if (source === discountPriceInput) {
            finalDiscountPrice = discountPriceVal;
        } else if (discountPercent > 0) {
            finalDiscountPrice = applyRounding(rawDiscountPrice, 'discount');
            discountPriceInput.value = finalDiscountPrice.toFixed(2);
        } else {
            finalDiscountPrice = discountPriceVal;
        }

        let profitDiscount = null;
        if (finalDiscountPrice > 0) {
            profitDiscount = finalDiscountPrice - costTotal;
        }

        document.getElementById("cost_total_display").textContent = costTotal.toFixed(2);
        document.getElementById("calculated_price_display").textContent = calculatedPrice.toFixed(2);
        document.getElementById("profit_final_display").textContent = profitFinal.toFixed(2);
        document.getElementById("summary_final_price").textContent = finalPrice.toFixed(2);

        if (finalDiscountPrice > 0) {
            document.getElementById("profit_discount_display").textContent = profitDiscount.toFixed(2);
            document.getElementById("summary_discount_price").textContent = finalDiscountPrice.toFixed(2);
        } else {
            document.getElementById("profit_discount_display").textContent = "–";
            document.getElementById("summary_discount_price").textContent = "–";
        }
    }

    // --- Currency Conversion Logic ---
    function fetchRate(curr, targetId) {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "...";
        btn.disabled = true;

        const urlPattern = "{{ url_for('api_nbs_rate', currency='__CURR__') }}";
        fetch(urlPattern.replace('__CURR__', curr))
            .then(resp => resp.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(targetId).value = data.rate.toFixed(4);
                    updateConversion();
                    const now = new Date();
                    const ts = now.toLocaleString('sr-RS');
                    document.getElementById('rate_status').textContent = `Kurs preuzet sa NBS (${ts}).`;
                } else {
                    alert(data.message);
                }
            })
            .catch(err => alert("Greška pri povezivanju."))
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
    }

    function fetchUsdEurRate() {
        const btn = event.target;
        const originalText = btn.textContent;
        btn.textContent = "...";
        btn.disabled = true;

        // Fetch both and calculate cross rate: EUR_RSD / USD_RSD
        const eurUrl = "{{ url_for('api_nbs_rate', currency='eur') }}";
        const usdUrl = "{{ url_for('api_nbs_rate', currency='usd') }}";
        Promise.all([
            fetch(eurUrl).then(r => r.json()),
            fetch(usdUrl).then(r => r.json())
        ]).then(([eurData, usdData]) => {
            if (eurData.success && usdData.success) {
                const crossRate = eurData.rate / usdData.rate;
                document.getElementById('conv_rate_usd_eur').value = crossRate.toFixed(4);
                updateConversion();
                const now = new Date();
                const ts = now.toLocaleString('sr-RS');
                document.getElementById('rate_status').textContent = `Kurs preuzet sa NBS (${ts}).`;
            } else {
                alert("Greška pri preuzimanju kurseva.");
            }
        }).catch(err => alert("Greška pri povezivanju."))
            .finally(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            });
    }

    function updateConversion() {
        const currency = document.getElementById("conv_currency").value;
        const amount = parseNumber(document.getElementById("conv_amount").value);
        const rsdBox = document.getElementById("rsd_rate_box");
        const usdBox = document.getElementById("usd_rate_box");

        if (currency === "RSD") {
            rsdBox.style.display = "block";
            usdBox.style.display = "none";

            const eurRate = parseNumber(document.getElementById("conv_rate_eur").value);
            const result = eurRate > 0 ? (amount / eurRate) : 0;
            document.getElementById("conv_result_display").textContent = result.toFixed(2);
        } else if (currency === "USD") {
            rsdBox.style.display = "none";
            usdBox.style.display = "block";

            const usdEurRate = parseNumber(document.getElementById("conv_rate_usd_eur").value);
            // Amount in USD / (EUR/USD rate) if rate is USD per 1 EUR
            // or Amount in USD * (EUR/USD rate) if rate is EUR per 1 USD
            // Based on NBS cross-rate calculation (EUR_RSD / USD_RSD), 
            // the result is "How many USD for 1 EUR" (e.g. 1.08)
            // So: EUR = USD / Rate
            const result = usdEurRate > 0 ? (amount / usdEurRate) : 0;
            document.getElementById("conv_result_display").textContent = result.toFixed(2);
        }
    }

    function applyConversion() {
        const result = parseNumber(document.getElementById("conv_result_display").textContent);
        if (result > 0) {
            const basePriceInput = document.getElementById("base_price");
            basePriceInput.value = result.toFixed(2);
            calculatePrice(basePriceInput);
        }
    }
</script>
{% endblock %}