{% extends "base.html" %}

{% block title %}
{% if product and product.id %}Edit Product{% else %}Add Product{% endif %}
{% endblock %}


{% block content %}
<h1>
    {% if product and product.id %}Edit Product{% else %}Add Product{% endif %}
</h1>
{% if error %}
<p style="color:red; font-weight:bold;">
    {{ error }}
</p>
{% endif %}
<div class="card">
    <form method="post" enctype="multipart/form-data">
        <p>
            {% if brand_options %}
            <label>Brand:<br>
                <select name="brand">
                    <option value="">-- choose brand --</option>
                    {% for b in brand_options %}
                    <option value="{{ b }}" {% if product and product.brand==b %}selected{% endif %}>
                        {{ b }}
                    </option>
                    {% endfor %}
                </select>
                </select>
                <a href="{{ url_for('brands') }}" class="btn btn-sm btn-primary" style="margin-top:5px;">Dodaj novi
                    brand</a>
            </label>
            {% else %}
            <label>Brand:<br>
                <input type="text" name="brand" value="{% if product %}{{ product.brand }}{% endif %}">
                <br>
                <small>No brands defined yet. Go to "Brands" first.</small>
            </label>
            {% endif %}
        </p>
        <p>
            {% if categories %}
            <label>Category:<br>
                <select name="category" required>
                    <option value="">-- choose category --</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {% if product and product.category==cat %}selected{% endif %}>
                        {{ cat }}
                    </option>
                    {% endfor %}
                </select>
                </select>
                <a href="{{ url_for('category_defaults') }}" class="btn btn-sm btn-primary"
                    style="margin-top:5px;">Dodaj
                    novu kategoriju</a>
            </label>
            {% else %}
            <label>Category:<br>
                <input type="text" name="category" value="{% if product %}{{ product.category }}{% endif %}">
                <br>
                <small>No categories defined yet. Go to "Category Defaults" first.</small>
            </label>
            {% endif %}
        </p>
        <p>
            <label>Name:<br>
                <input type="text" name="name" required class="long-input"
                    value="{% if product %}{{ product.name }}{% endif %}">
            </label>
        </p>
        <p>
            <label>Description:<br>
                <textarea name="description" rows="8"
                    cols="80">{% if product %}{{ product.description }}{% endif %}</textarea>
            </label>
        </p>
        <p>
            <label>Photo (JPG,PNG):<br>
                <div class="file-upload-wrapper">
                    {% if product and product.photo_path %}
                    <div style="margin-bottom: 10px;">
                        <p>Trenutna fotografija: {{ product.photo_path }}</p>
                        <img src="{{ url_for('product_image', filename=product.photo_path) }}"
                            style="max-width:200px; max-height:200px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    </div>
                    {% endif %}

                    <input type="file" name="photo_file" accept="image/jpeg, image/png">
                    <span class="file-upload-text">Klikni ili prevuci sliku ovde</span>
                </div>

                <div
                    style="margin-top: 15px; padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-card); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);">
                    <label style="margin-bottom: 10px; color: var(--text-main); font-size: 14px;">ILI unesite URL
                        slike:</label>
                    <input type="url" name="photo_url" placeholder="https://example.com/image.jpg"
                        value="{% if product and product.photo_url %}{{ product.photo_url }}{% endif %}">
                </div>
            </label>
        </p>
        <p>
            <button type="submit" class="btn btn-success" name="action" value="save">
                {% if product and product.id %}Sacuvaj izmene{% else %}Sacuvaj{% endif %}
            </button>
            {% if not product or not product.id %}
            <button type="submit" class="btn btn-primary" name="action" value="save_add_price"
                style="margin-left: 10px;">
                Sacuvaj i dodaj cenu
            </button>
            {% else %}
            <a href="{{ url_for('price_history', product_id=product.id) }}" class="btn"
                style="margin-left: 10px; border:1px solid #ccc; text-decoration:none; padding: 6px 12px; color: var(--text-main);">
                Istorija cena
            </a>
            <a href="{{ url_for('new_price', product_id=product.id) }}" class="btn btn-primary"
                style="margin-left: 10px;">
                Dodaj novu cenu
            </a>
            {% endif %}
        </p>
    </form>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const fileInput = document.querySelector('input[type="file"][name="photo_file"]');
        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                const fileName = e.target.files[0]?.name;
                const wrapper = e.target.closest('.file-upload-wrapper');
                const textSpan = wrapper.querySelector('.file-upload-text');

                if (fileName && textSpan) {
                    textSpan.textContent = "Izabrano: " + fileName;
                    textSpan.style.color = "var(--accent-success)";
                    textSpan.style.fontWeight = "600";
                    wrapper.style.borderColor = "var(--accent-success)";
                }
            });
        }
    });
</script>
{% endblock %}