<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <title>Edit Template - {{ template.name }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <style>
        .editor-section {
            margin-bottom: 30px;
        }

        .editor-section h4 {
            margin-bottom: 10px;
            color: var(--accent-primary);
            display: flex;
            justify-content: space-between;
        }

        textarea.code-editor {
            width: 100%;
            height: 300px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 13px;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            line-height: 1.5;
            resize: vertical;
        }

        .readonly {
            opacity: 0.7;
            background: #252525 !important;
        }
    </style>
</head>

<body>
    <nav>
        <div class="nav-links">
            <span style="font-weight: 600; color: var(--text-main);">Admin Panel</span>
            <a href="{{ url_for('index') }}">Dashboard</a>
            <a href="{{ url_for('list_pdf_templates') }}">PDF Templates</a>
            <span style="color: var(--text-muted);">/ Edit: {{ template.name }}</span>
        </div>
        <div class="nav-links">
            <a href="{{ url_for('logout') }}">Logout</a>
        </div>
    </nav>

    <div class="container" style="max-width: 1400px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Edit PDF Template: {{ template.name }}</h1>
            <div style="display: flex; gap: 10px;">
                <a href="{{ url_for('list_pdf_templates') }}" class="btn btn-secondary">Back to List</a>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
        {% for category, message in messages %}
        <div class="alert alert-{{ 'success' if category == 'success' else 'error' }}">
            {{ message }}
        </div>
        {% endfor %}
        {% endif %}
        {% endwith %}

        <div class="grid-2-col-asymmetric" style="grid-template-columns: 2fr 1fr; gap: 40px;">
            <!-- Left: Editors -->
            <div>
                <form action="{{ url_for('edit_pdf_template', template_id=template.id) }}" method="POST">
                    <div class="card">
                        <label>Template Name</label>
                        <input type="text" name="name" value="{{ template.name }}" required {{ 'readonly' if
                            template.is_readonly }}>

                        <hr style="margin: 20px 0;">

                        <div class="editor-section">
                            <h4>Header HTML</h4>
                            <textarea name="header_html" class="code-editor {{ 'readonly' if template.is_readonly }}"
                                {{ 'readonly' if template.is_readonly }}>{{ template.header_html }}</textarea>
                        </div>

                        <div class="editor-section">
                            <h4>Body HTML</h4>
                            <textarea name="body_html" class="code-editor {{ 'readonly' if template.is_readonly }}"
                                {{ 'readonly' if template.is_readonly }}>{{ template.body_html }}</textarea>
                        </div>

                        <div class="editor-section">
                            <h4>Footer HTML</h4>
                            <textarea name="footer_html" class="code-editor {{ 'readonly' if template.is_readonly }}"
                                {{ 'readonly' if template.is_readonly }}>{{ template.footer_html }}</textarea>
                        </div>

                        <div class="editor-section">
                            <h4>Global CSS (PDF)</h4>
                            <textarea name="css" class="code-editor {{ 'readonly' if template.is_readonly }}"
                                {{ 'readonly' if template.is_readonly }}>{{ template.css }}</textarea>
                        </div>

                        {% if not template.is_readonly %}
                        <button type="submit" class="btn btn-primary" style="width: 100%; font-size: 1.1rem;">Save
                            Template Changes</button>
                        {% else %}
                        <div class="alert alert-info">This is a system template and cannot be modified. Clone it to
                            create a custom version.</div>
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- Right: Preview Tools -->
            <div>
                <div class="card" style="position: sticky; top: 20px;">
                    <h3>Preview / Test</h3>
                    <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 20px;">
                        Select a quotation to see how it looks with this template.
                        <br><strong>Note:</strong> You must save changes before previewing.
                    </p>

                    <form id="preview-form" target="_blank">
                        <label>Select Quotation</label>
                        <select name="offer_id" id="offer-id" required>
                            <option value="">-- Choose --</option>
                            {% for o in offers %}
                            <option value="{{ o.id }}">
                                #{{ o.offer_number or o.id }} - {{ o.client_name }}
                            </option>
                            {% endfor %}
                        </select>

                        <button type="button" onclick="runPreview()" class="btn btn-secondary"
                            style="width: 100%; margin-top: 15px;">üîç Preview PDF</button>
                    </form>

                    <script>
                        function runPreview() {
                            const offerId = document.getElementById('offer-id').value;
                            if (!offerId) {
                                alert('Please select a quotation first.');
                                return;
                            }
                            // Redirect to quotation app print route with template override
                            const url = '/quotation/offers/' + offerId + '/pdf?preview_template_id={{ template.id }}';
                            window.open(url, '_blank');
                        }
                    </script>
                </div>
            </div>
        </div>
    </div>
</body>

</html>